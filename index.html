<!DOCTYPE html>
<html>
<head>
    <title>年日月三柱納音自動速查 (1984-2030)</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        /* 網頁樣式 */
        body { font-family: 'Microsoft JhengHei', Arial, sans-serif; text-align: center; padding: 20px; background-color: #f4f4f9; }
        .container { max-width: 650px; margin: 20px auto; padding: 30px; border: 1px solid #ddd; border-radius: 10px; background-color: #fff; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        h1 { color: #333; border-bottom: 2px solid #0066cc; padding-bottom: 10px; margin-bottom: 20px; }
        .input-group { margin-bottom: 20px; padding: 15px; border: 1px solid #eee; border-radius: 5px; }
        input[type="number"], button { padding: 12px; margin: 8px 0; width: 100%; box-sizing: border-box; border: 1px solid #ccc; border-radius: 5px; font-size: 1em; }
        button { background-color: #0066cc; color: white; cursor: pointer; border: none; transition: background-color 0.3s; }
        button:hover { background-color: #0052a3; }
        .result-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 25px; }
        .result-item { border: 2px solid #ddd; padding: 15px 5px; border-radius: 5px; background-color: #fff0f5; }
        .result-item h3 { margin: 0 0 5px 0; font-size: 1em; color: #666; }
        .ganzhi-value { font-size: 1.2em; font-weight: bold; color: #0066cc; margin-bottom: 5px; }
        .nayin-value { font-size: 1.1em; font-weight: bold; color: #cc0000; }
        .note { font-size: 0.8em; color: #666; margin-top: 20px; text-align: left; }
        /* 限制輸入範圍的樣式 */
        .range-note { color: red; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <h1>年、月、日三柱納音自動速查</h1>
    <p class="range-note">本系統適用於國曆 1984/1/1 至 2030/12/31 之間的日期</p>
    
    <div class="input-group">
        <h2>請輸入國曆生日</h2>
        <input type="number" id="birthYear" placeholder="年份：例如 1984" min="1984" max="2030">
        <input type="number" id="birthMonth" placeholder="月份：例如 2" min="1" max="12">
        <input type="number" id="birthDay" placeholder="日期：例如 4" min="1" max="31">
    </div>
    
    <button onclick="calculateNayin()">自動計算納音五行</button>
    
    <div class="result-grid" id="result">
        <div class="result-item"><h3>年柱</h3><div class="ganzhi-value" id="ganzhi_year">---</div><div class="nayin-value" id="nayin_year">待計算</div></div>
        <div class="result-item"><h3>月柱</h3><div class="ganzhi-value" id="ganzhi_month">---</div><div class="nayin-value" id="nayin_month">待計算</div></div>
        <div class="result-item"><h3>日柱</h3><div class="ganzhi-value" id="ganzhi_day">---</div><div class="nayin-value" id="nayin_day">待計算</div></div>
    </div>
    
    <p class="note">
        * 本程式碼已自動計算年、月、日三柱的干支及納音五行。<br>
        * 日柱採用萬年曆演算法，無需外部數據庫。<br>
        * 月柱計算採用節氣近似值，已盡力提高準確度。
    </p>
</div>

<script>
// =======================================================
// 數據結構定義
// =======================================================
const TIAN_GAN = ['甲', '乙', '丙', '丁', '戊', '己', '庚', '辛', '壬', '癸'];
const DI_ZHI = ['子', '丑', '寅', '卯', '辰', '巳', '午', '未', '申', '酉', '戌', '亥'];

// 1. 納音五行查找表 (60 甲子，索引 0 = 甲子)
const NAYIN_60_MAP = [
    '海中金', '海中金', '爐中火', '爐中火', '大林木', '大林木', '路旁土', '路旁土', '劍鋒金', '劍鋒金',
    '山頭火', '山頭火', '澗下水', '澗下水', '城頭土', '城頭土', '白蠟金', '白蠟金', '楊柳木', '楊柳木',
    '井泉水', '井泉水', '屋上土', '屋上土', '霹靂火', '霹靂火', '松柏木', '松柏木', '長流水', '長流水',
    '沙中金', '沙中金', '山下火', '山下火', '平地木', '平地木', '壁上土', '壁上土', '金箔金', '金箔金',
    '覆燈火', '覆燈火', '天河水', '天河水', '大驛土', '大驛土', '釵釧金', '釵釧金', '桑柘木', '桑柘木',
    '大溪水', '大溪水', '沙中土', '沙中土', '天上火', '天上火', '石榴木', '石榴木', '大海水', '大海水'
];

// 2. 年柱立春對照表 (數據範圍已根據要求調整為 1984-2030)
const LICHUN_MAP = {
    '1984': '2/4', '1985': '2/4', '1986': '2/4', '1987': '2/4', '1988': '2/4', '1989': '2/4',
    '1990': '2/4', '1991': '2/4', '1992': '2/4', '1993': '2/4', '1994': '2/4', '1995': '2/4',
    '1996': '2/4', '1997': '2/4', '1998': '2/4', '1999': '2/4', '2000': '2/4', '2001': '2/4', 
    '2002': '2/4', '2003': '2/4', '2004': '2/4', '2005': '2/4', '2006': '2/4', '2007': '2/4', 
    '2008': '2/4', '2009': '2/4', '2010': '2/4', '2011': '2/4', '2012': '2/4', '2013': '2/4', 
    '2014': '2/4', '2015': '2/4', '2016': '2/4', '2017': '2/3', '2018': '2/4', '2019': '2/4', 
    '2020': '2/4', '2021': '2/3', '2022': '2/4', '2023': '2/4', '2024': '2/4', '2025': '2/3', 
    '2026': '2/4', '2027': '2/4', '2028': '2/4', '2029': '2/3', '2030': '2/4',
};

// 3. 月柱干支查找表 (五虎遁) - 根據年干定寅月干支
const WU_HU_DUN_START = [0, 2, 4, 6, 8, 0, 2, 4, 6, 8]; // 甲, 丙, 戊, 庚, 壬

// 4. 節氣轉換表 (簡化近似版，用於月柱判斷)
const JIE_QI_MONTH_MAP = [
    { month: 1, day: 6, branch: '丑', index: 1 }, // 小寒，對應丑月 (索引 1)
    { month: 2, day: 4, branch: '寅', index: 2 }, // 立春，對應寅月 (索引 2)
    { month: 3, day: 6, branch: '卯', index: 3 }, // 驚蟄，對應卯月 (索引 3)
    { month: 4, day: 5, branch: '辰', index: 4 }, // 清明，對應辰月 (索引 4)
    { month: 5, day: 6, branch: '巳', index: 5 }, // 立夏，對應巳月 (索引 5)
    { month: 6, day: 6, branch: '午', index: 6 }, // 芒種，對應午月 (索引 6)
    { month: 7, day: 7, branch: '未', index: 7 }, // 小暑，對應未月 (索引 7)
    { month: 8, day: 8, branch: '申', index: 8 }, // 立秋，對應申月 (索引 8)
    { month: 9, day: 8, branch: '酉', index: 9 }, // 白露，對應酉月 (索引 9)
    { month: 10, day: 8, branch: '戌', index: 10 }, // 寒露，對應戌月 (索引 10)
    { month: 11, day: 8, branch: '亥', index: 11 }, // 立冬，對應亥月 (索引 11)
    { month: 12, day: 7, branch: '子', index: 0 }  // 大雪，對應子月 (索引 0)
];


// =======================================================
// 輔助功能函數 (用於日柱的萬年曆計算)
// =======================================================

// 1. 判斷是否為閏年
function isLeap(year) {
    return (year % 4 === 0 && year % 100 !== 0) || (year % 400 === 0);
}

// 2. 計算從 1900/1/1 到目標日期之間經過的總天數 (日柱萬年曆核心)
function daysSince1900(year, month, day) {
    const DAYS_IN_MONTH = [0, 31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];
    let totalDays = 0;

    // 計算經過整年的天數
    for (let y = 1900; y < year; y++) {
        totalDays += isLeap(y) ? 366 : 365;
    }

    // 計算經過整月的天數
    for (let m = 1; m < month; m++) {
        let days = DAYS_IN_MONTH[m];
        if (m === 2 && isLeap(year)) {
            days = 29;
        }
        totalDays += days;
    }

    // 加上當月的天數
    totalDays += day;
    
    // 1900/1/1 本身算第 1 天，但公式習慣從 0 開始，所以要減 1
    return totalDays - 1; 
}

// 3. 根據 60 甲子索引查找納音
function getNayinFromIndex(index) {
    if (index < 0 || index >= 60) return "---";
    return NAYIN_60_MAP[index];
}


// =======================================================
// 核心計算函數
// =======================================================
function calculateNayin() {
    // 1. 獲取輸入
    const year = parseInt(document.getElementById('birthYear').value);
    const month = parseInt(document.getElementById('birthMonth').value);
    const day = parseInt(document.getElementById('birthDay').value);
    
    // 重設結果
    document.getElementById('ganzhi_year').textContent = "---";
    document.getElementById('nayin_year').textContent = "---";
    document.getElementById('ganzhi_month').textContent = "---";
    document.getElementById('nayin_month').textContent = "---";
    document.getElementById('ganzhi_day').textContent = "---";
    document.getElementById('nayin_day').textContent = "---";

    // 範圍檢查 (嚴格遵循 1984 - 2030)
    if (isNaN(year) || isNaN(month) || isNaN(day) || year < 1984 || year > 2030) {
        document.getElementById('ganzhi_year').textContent = "日期錯誤";
        document.getElementById('nayin_year').textContent = "請輸入 1984-2030 年的年月日";
        return;
    }


    // ----------------------------------------------------------------
    // 2. 年柱計算 (Year Pillar)
    // ----------------------------------------------------------------
    const startYear = 1900; // 1900 庚子年 (Index 36)
    const yearStr = year.toString();
    const lichunDateStr = LICHUN_MAP[yearStr];
    
    let actualYear = year;
    
    // 根據立春判斷實際的農曆年
    if (lichunDateStr) {
        const [lcMonth, lcDay] = lichunDateStr.split('/').map(Number);
        if (month < lcMonth || (month === lcMonth && day < lcDay)) {
            actualYear = year - 1; // 立春前算去年
        }
    }
    
    // 計算年干支索引 (0-59)
    const yearDifference = actualYear - startYear;
    const yearGanZhiIndex = (36 + yearDifference) % 60; // 36 是 1900 庚子的索引
    const yearGanIndex = yearGanZhiIndex % 10;
    
    // 顯示年柱干支與納音
    const yearGan = TIAN_GAN[yearGanZhiIndex % 10];
    const yearZhi = DI_ZHI[yearGanZhiIndex % 12];
    document.getElementById('ganzhi_year').textContent = `${yearGan}${yearZhi}`;
    document.getElementById('nayin_year').textContent = getNayinFromIndex(yearGanZhiIndex);


    // ----------------------------------------------------------------
    // 3. 月柱計算 (Month Pillar - 節氣算法)
    // ----------------------------------------------------------------
    
    let currentZhiIndex = -1;
    let currentMonthBranch = '---';
    let monthFound = false;
    
    // 查找該日期應該對應的地支月
    for (let i = 0; i < JIE_QI_MONTH_MAP.length; i++) {
        const jq = JIE_QI_MONTH_MAP[i];
        
        // 處理跨年地支 (子月/丑月)
        if (month === 1) { // 國曆 1月，可能落在 子月(去年底) 或 丑月(今年初)
             if (day < JIE_QI_MONTH_MAP[0].day) { // 1/6 之前，算子月 (上一個地支)
                currentMonthBranch = JIE_QI_MONTH_MAP[11].branch; // 子
                currentZhiIndex = DI_ZHI.indexOf(currentMonthBranch);
                monthFound = true;
                break;
            }
        }
        
        if (month < jq.month || (month === jq.month && day < jq.day)) {
            // 如果日期在該節氣之前，則為上一個地支月
            const prevIndex = (i - 1 + 12) % 12;
            currentMonthBranch = JIE_QI_MONTH_MAP[prevIndex].branch;
            currentZhiIndex = DI_ZHI.indexOf(currentMonthBranch);
            monthFound = true;
            break;
        }
        
        // 如果是 12月的節氣之後 (12/7 大雪之後)，則算子月
        if (i === 11 && month === 12 && day >= jq.day) {
            currentMonthBranch = jq.branch; // 子月
            currentZhiIndex = DI_ZHI.indexOf(currentMonthBranch);
            monthFound = true;
            break;
        }
    }
    
    // 如果循環結束但未找到 (通常是因為日期剛好在最後一個節氣之後，但不是 12月的情況，例如 11月)
    if (!monthFound) {
        // 假設為 11月的節氣之後 (亥月)
        currentMonthBranch = JIE_QI_MONTH_MAP[10].branch; 
        currentZhiIndex = DI_ZHI.indexOf(currentMonthBranch);
    }
    
    // 2. 根據 年干 和 月支 判斷月干 (五虎遁)
    // 月干起始點：寅月（地支索引 2）的干支索引 (0=甲, 2=丙, 4=戊...)
    const yueGanStart = WU_HU_DUN_START[yearGanIndex];
    
    // 計算當前月支 (currentMonthBranch) 與 寅月 (寅 = 地支索引 2) 的距離
    const yinZhiIndex = DI_ZHI.indexOf('寅');
    const distanceToYin = (currentZhiIndex - yinZhiIndex + 12) % 12;
    
    // 換算月干索引
    const monthGanIndex = (yueGanStart + distanceToYin) % 10;
    
    // 組合月柱干支並查找納音
    const monthGan = TIAN_GAN[monthGanIndex];
    const monthZhi = currentMonthBranch;
    
    // 計算 60 甲子索引: (干索引 * 6 + 支索引) % 60 是一個快速公式
    const monthGanZhiIndex = (monthGanIndex * 6 + currentZhiIndex) % 60; 
    
    document.getElementById('ganzhi_month').textContent = `${monthGan}${monthZhi}`;
    document.getElementById('nayin_month').textContent = getNayinFromIndex(monthGanZhiIndex);


    // ----------------------------------------------------------------
    // 4. 日柱計算 (Day Pillar - 萬年曆算法)
    // ----------------------------------------------------------------
    // 基準日: 1900/1/1 是 丁酉 (索引 43)
    const DAY_EPOCH_INDEX = 43; 

    // 計算從 1900/1/1 經過的總天數
    const totalDays = daysSince1900(year, month, day);
    
    // 計算日干支索引
    const dayGanZhiIndex = (DAY_EPOCH_INDEX + totalDays) % 60;
    
    // 顯示日柱干支與納音
    const dayGan = TIAN_GAN[dayGanZhiIndex % 10];
    const dayZhi = DI_ZHI[dayGanZhiIndex % 12];
    
    document.getElementById('ganzhi_day').textContent = `${dayGan}${dayZhi}`;
    document.getElementById('nayin_day').textContent = getNayinFromIndex(dayGanZhiIndex);
}
</script>

</body>
</html>
